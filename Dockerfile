FROM maven:3-eclipse-temurin-21-alpine as builder
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline
COPY src/ ./src/
RUN mvn clean package -DskipTests=true

FROM eclipse-temurin:21-jdk-alpine as prod
COPY --from=builder /app/target/*.jar /app.jar

# SERVER AND APPLICATION CONFIGURATIONS ARGS
ARG SPRING_PROFILES_ACTIVE
ARG PORT
ARG APP_VERSION
ARG APP_SERVER_URL
ARG APP_SECRET
ARG APP_ENVIRONMENT
ARG APP_EMAIL_SENDER
ARG APP_EMAIL_PASSWORD
ARG SPRING_APPLICATION_NAME
# DATABASE CONFIGURATIONS ARGS
ARG SPRING_DATASOURCE_URL
ARG SPRING_DATASOURCE_USERNAME
ARG SPRING_DATASOURCE_PASSWORD
ARG SPRING_JPA_SHOW_SQL
# SERVER AND APPLICATION CONFIGURATIONS
WORKDIR /app
ENV SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
ENV PORT=${PORT}
ENV APP_VERSION=${APP_VERSION}
ENV APP_SERVER_URL=${APP_SERVER_URL}
ENV APP_SECRET=${APP_SECRET}
ENV APP_ENVIRONMENT=${APP_ENVIRONMENT}
ENV APP_EMAIL_SENDER=${APP_EMAIL_SENDER}
ENV APP_EMAIL_PASSWORD=${APP_EMAIL_PASSWORD}
# DATABASE CONFIGURATIONS
ENV SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
ENV SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
ENV SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
ENV SPRING_JPA_SHOW_SQL=${SPRING_JPA_SHOW_SQL}
# EXPOSE THE PORT
EXPOSE ${PORT}
# RUN THE APPLICATION
ENTRYPOINT ["java", "-jar", "/app.jar"]
